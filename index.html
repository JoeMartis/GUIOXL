<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open edX Problem Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #0075b4;
            margin-bottom: 30px;
        }

        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .editor-container {
                grid-template-columns: 1fr;
            }
        }

        .editor-panel, .output-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .section {
            margin-bottom: 25px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .section-title {
            font-weight: 600;
            color: #444;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .quill-wrapper {
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .quill-wrapper .ql-container {
            min-height: 100px;
            font-size: 14px;
        }

        .quill-wrapper.small .ql-container {
            min-height: 60px;
        }

        .ql-toolbar {
            border: none !important;
            border-bottom: 1px solid #ddd !important;
            background: #fafafa;
        }

        .ql-container {
            border: none !important;
        }

        .choice-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #eee;
        }

        .choice-item.correct {
            background: #e8f5e9;
            border-color: #a5d6a7;
        }

        .choice-controls {
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding-top: 8px;
        }

        .choice-editor {
            flex: 1;
        }

        .choice-editor .quill-wrapper .ql-container {
            min-height: 50px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #0075b4;
            color: white;
        }

        .btn-primary:hover {
            background: #005a8c;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #388e3c;
        }

        .btn-danger {
            background: #f44336;
            color: white;
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn-sm {
            padding: 4px 10px;
            font-size: 12px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
            white-space: nowrap;
        }

        .radio-label input {
            cursor: pointer;
        }

        #olx-output {
            width: 100%;
            height: 400px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #1e1e1e;
            color: #d4d4d4;
            resize: vertical;
        }

        .btn-warning {
            background: #ff9800;
            color: white;
        }

        .btn-warning:hover {
            background: #f57c00;
        }

        .import-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .import-instructions {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .output-title {
            font-weight: 600;
            color: #444;
            font-size: 16px;
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        .copy-feedback {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .copy-feedback.show {
            opacity: 1;
        }

        .problem-type-selector {
            margin-bottom: 20px;
        }

        .problem-type-selector select {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .hint-section {
            margin-top: 10px;
        }

        .hint-item {
            margin-bottom: 10px;
        }

        .add-btn-container {
            margin-top: 10px;
        }

        /* Checkbox styling for multiple select */
        .choice-type-indicator {
            font-size: 11px;
            color: #888;
            margin-top: 2px;
        }

        .answer-section {
            display: none;
        }

        .answer-section.visible {
            display: block;
        }

        .answer-input {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .answer-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .answer-options label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            color: #555;
        }

        .tolerance-input {
            width: 100px;
            padding: 8px;
            font-size: 13px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .hidden {
            display: none !important;
        }

        .validation-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 13px;
            display: none;
        }

        .validation-warning.show {
            display: block;
        }
    </style>
</head>
<body>
    <h1>Open edX Problem Editor</h1>

    <div class="copy-feedback" id="copyFeedback">Copied to clipboard!</div>

    <div class="editor-container">
        <div class="output-panel">
            <div class="import-section">
                <div class="output-header">
                    <span class="output-title">OLX</span>
                </div>
                <p class="import-instructions">Paste OLX here to edit it visually. Changes auto-sync both ways.</p>
            </div>
            <textarea id="olx-output" placeholder="Paste OLX here..."></textarea>
            <div class="btn-group" style="margin-top: 15px; justify-content: flex-end;">
                <button class="btn btn-success" onclick="copyOLX()">Copy to Clipboard</button>
            </div>
        </div>

        <div class="editor-panel">
            <div class="problem-type-selector">
                <label class="section-title">Problem Type</label>
                <select id="problemType" onchange="updateProblemType()">
                    <option value="multiplechoiceresponse">Multiple Choice (Single Answer)</option>
                    <option value="choiceresponse">Checkboxes (Multiple Answers)</option>
                    <option value="numericalresponse">Numerical Response</option>
                    <option value="stringresponse">Text Response</option>
                </select>
            </div>

            <div class="section">
                <div class="section-header">
                    <span class="section-title">Problem Label / Question</span>
                </div>
                <div class="quill-wrapper">
                    <div id="label-editor"></div>
                </div>
            </div>

            <div class="section" id="choices-section">
                <div class="section-header">
                    <span class="section-title">Answer Choices</span>
                    <button class="btn btn-primary btn-sm" onclick="addChoice()">+ Add Choice</button>
                </div>
                <div class="validation-warning" id="no-correct-warning">
                    No correct answer selected. Please mark at least one choice as correct.
                </div>
                <div id="choices-container"></div>
            </div>

            <div class="section answer-section" id="answer-section">
                <div class="section-header">
                    <span class="section-title">Correct Answer</span>
                </div>
                <input type="text" id="correct-answer" class="answer-input" placeholder="Enter the correct answer...">
                <div class="answer-options" id="numerical-options">
                    <label>
                        Tolerance: &#177;
                        <input type="text" id="answer-tolerance" class="tolerance-input" placeholder="e.g., 5%">
                    </label>
                </div>
                <div class="answer-options" id="string-options" style="display: none;">
                    <label>
                        <input type="checkbox" id="string-case-sensitive">
                        Case sensitive
                    </label>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <span class="section-title">Explanation / Solution</span>
                </div>
                <div class="quill-wrapper">
                    <div id="explanation-editor"></div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <span class="section-title">Hints (Optional)</span>
                    <button class="btn btn-primary btn-sm" onclick="addHint()">+ Add Hint</button>
                </div>
                <div id="hints-container"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <script>
        // Quill toolbar configuration
        const toolbarOptions = [
            ['bold', 'italic', 'underline', 'strike'],
            ['code', 'blockquote'],
            ['link'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'script': 'sub'}, { 'script': 'super' }],
            ['clean']
        ];

        const minimalToolbar = [
            ['bold', 'italic', 'underline'],
            ['code'],
            ['link'],
            ['clean']
        ];

        // Initialize main editors
        const labelEditor = new Quill('#label-editor', {
            theme: 'snow',
            modules: { toolbar: toolbarOptions },
            placeholder: 'Enter your question here...'
        });

        const explanationEditor = new Quill('#explanation-editor', {
            theme: 'snow',
            modules: { toolbar: toolbarOptions },
            placeholder: 'Enter the explanation/solution here...'
        });

        // Choice management
        let choiceEditors = [];
        let choiceCount = 0;
        let hintEditors = [];
        let hintCount = 0;

        // Flags to prevent import/generate loops (must be declared before use)
        let isImporting = false;
        let isGenerating = false;

        function addChoice(isCorrect = false) {
            const container = document.getElementById('choices-container');
            const choiceId = choiceCount++;
            const problemType = document.getElementById('problemType').value;
            const inputType = problemType === 'choiceresponse' ? 'checkbox' : 'radio';

            const choiceDiv = document.createElement('div');
            choiceDiv.className = 'choice-item' + (isCorrect ? ' correct' : '');
            choiceDiv.id = `choice-${choiceId}`;
            choiceDiv.innerHTML = `
                <div class="choice-controls">
                    <label class="radio-label">
                        <input type="${inputType}" name="correct-choice" value="${choiceId}" ${isCorrect ? 'checked' : ''} onchange="updateCorrectChoice(${choiceId})">
                        Correct
                    </label>
                    <button class="btn btn-danger" onclick="removeChoice(${choiceId})">Remove</button>
                </div>
                <div class="choice-editor">
                    <div class="quill-wrapper small">
                        <div id="choice-editor-${choiceId}"></div>
                    </div>
                </div>
            `;
            container.appendChild(choiceDiv);

            const editor = new Quill(`#choice-editor-${choiceId}`, {
                theme: 'snow',
                modules: { toolbar: minimalToolbar },
                placeholder: 'Enter choice text...'
            });

            choiceEditors[choiceId] = editor;
        }

        function removeChoice(id) {
            const element = document.getElementById(`choice-${id}`);
            if (element) {
                element.remove();
                delete choiceEditors[id];
                validateChoices();
            }
        }

        function updateCorrectChoice(id) {
            const problemType = document.getElementById('problemType').value;

            if (problemType === 'choiceresponse') {
                // Checkboxes - multiple can be correct
                const choiceDiv = document.getElementById(`choice-${id}`);
                const checkbox = choiceDiv.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    choiceDiv.classList.add('correct');
                } else {
                    choiceDiv.classList.remove('correct');
                }
            } else {
                // Radio buttons - only one correct
                document.querySelectorAll('.choice-item').forEach(item => {
                    item.classList.remove('correct');
                });
                const choiceDiv = document.getElementById(`choice-${id}`);
                if (choiceDiv) {
                    choiceDiv.classList.add('correct');
                }
            }

            validateChoices();
        }

        function updateProblemType() {
            const problemType = document.getElementById('problemType').value;
            const choicesSection = document.getElementById('choices-section');
            const answerSection = document.getElementById('answer-section');
            const numericalOptions = document.getElementById('numerical-options');
            const stringOptions = document.getElementById('string-options');

            // Show/hide sections based on problem type
            if (problemType === 'numericalresponse' || problemType === 'stringresponse') {
                choicesSection.classList.add('hidden');
                answerSection.classList.add('visible');

                if (problemType === 'numericalresponse') {
                    numericalOptions.style.display = 'flex';
                    stringOptions.style.display = 'none';
                    document.getElementById('correct-answer').placeholder = 'Enter the correct numerical answer...';
                } else {
                    numericalOptions.style.display = 'none';
                    stringOptions.style.display = 'flex';
                    document.getElementById('correct-answer').placeholder = 'Enter the correct text answer...';
                }
            } else {
                choicesSection.classList.remove('hidden');
                answerSection.classList.remove('visible');

                const inputType = problemType === 'choiceresponse' ? 'checkbox' : 'radio';

                // Update all existing choice inputs
                document.querySelectorAll('.choice-item').forEach(item => {
                    const input = item.querySelector('input');
                    input.type = inputType;

                    // For radio, keep only first checked; for checkbox, preserve all
                    if (inputType === 'radio') {
                        item.classList.remove('correct');
                        input.checked = false;
                    }
                });

                // If switching to radio, select first choice as correct by default
                if (inputType === 'radio') {
                    const firstInput = document.querySelector('.choice-item input');
                    if (firstInput) {
                        firstInput.checked = true;
                        firstInput.closest('.choice-item').classList.add('correct');
                    }
                }
            }
        }

        function addHint() {
            const container = document.getElementById('hints-container');
            const hintId = hintCount++;

            const hintDiv = document.createElement('div');
            hintDiv.className = 'hint-item';
            hintDiv.id = `hint-${hintId}`;
            hintDiv.innerHTML = `
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <div style="flex: 1;">
                        <div class="quill-wrapper small">
                            <div id="hint-editor-${hintId}"></div>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="removeHint(${hintId})" style="margin-top: 8px;">Remove</button>
                </div>
            `;
            container.appendChild(hintDiv);

            const editor = new Quill(`#hint-editor-${hintId}`, {
                theme: 'snow',
                modules: { toolbar: minimalToolbar },
                placeholder: 'Enter hint text...'
            });

            hintEditors[hintId] = editor;
        }

        function removeHint(id) {
            const element = document.getElementById(`hint-${id}`);
            if (element) {
                element.remove();
                delete hintEditors[id];
            }
        }

        function escapeXml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }

        function validateChoices() {
            const problemType = document.getElementById('problemType').value;
            const warning = document.getElementById('no-correct-warning');

            // Only validate for choice-based problems
            if (problemType === 'numericalresponse' || problemType === 'stringresponse') {
                warning.classList.remove('show');
                return true;
            }

            // Check if any choice is marked correct
            const hasCorrect = document.querySelector('.choice-item input:checked') !== null;
            const hasChoices = document.querySelectorAll('.choice-item').length > 0;

            if (hasChoices && !hasCorrect) {
                warning.classList.add('show');
                return false;
            } else {
                warning.classList.remove('show');
                return true;
            }
        }

        function quillToHtml(editor) {
            let html = editor.root.innerHTML;
            // Clean up empty content
            if (html === '<p><br></p>') return '';

            // Remove Quill's code-block containers if any remain
            html = html.replace(/<div class="ql-code-block-container"[^>]*>.*?<\/div><\/div>/gs, '');
            html = html.replace(/<div class="ql-code-block"[^>]*>(.*?)<\/div>/gs, '<code>$1</code>');

            // Only remove empty <p> tags, keep ones with content
            html = html.replace(/<p><br><\/p>/g, '');
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p>\s*<\/p>/g, '');

            // If it's just a single <p> wrapper around content (no nested <p>), unwrap it
            const singlePMatch = html.match(/^<p>([^]*)<\/p>$/);
            if (singlePMatch && !singlePMatch[1].includes('<p>') && !singlePMatch[1].includes('</p>')) {
                html = singlePMatch[1];
            }

            return html.trim();
        }

        function generateOLX() {
            if (isImporting) return; // Don't generate while importing

            isGenerating = true;

            // Validate choices
            validateChoices();

            const problemType = document.getElementById('problemType').value;
            const labelHtml = quillToHtml(labelEditor);
            const explanationHtml = quillToHtml(explanationEditor);

            // Gather hints
            const hints = [];
            const hintElements = document.querySelectorAll('.hint-item');
            hintElements.forEach(element => {
                const id = element.id.replace('hint-', '');
                const editor = hintEditors[id];
                if (editor) {
                    const html = quillToHtml(editor);
                    if (html) {
                        hints.push(html);
                    }
                }
            });

            // Build OLX
            let olx = `<problem>\n`;

            if (problemType === 'numericalresponse') {
                const answer = escapeXml(document.getElementById('correct-answer').value || '');
                const tolerance = escapeXml(document.getElementById('answer-tolerance').value || '');

                olx += `  <numericalresponse answer="${answer}"`;
                if (tolerance) {
                    olx += ` tolerance="${tolerance}"`;
                }
                olx += `>\n`;
                olx += `    <label>${labelHtml}</label>\n`;
                olx += `    <textline/>\n`;
                olx += `  </numericalresponse>\n`;

            } else if (problemType === 'stringresponse') {
                const answer = escapeXml(document.getElementById('correct-answer').value || '');
                const caseSensitive = document.getElementById('string-case-sensitive').checked;

                olx += `  <stringresponse answer="${answer}" type="${caseSensitive ? 'cs' : 'ci'}">\n`;
                olx += `    <label>${labelHtml}</label>\n`;
                olx += `    <textline size="20"/>\n`;
                olx += `  </stringresponse>\n`;

            } else if (problemType === 'multiplechoiceresponse') {
                // Gather choices
                const choices = [];
                const choiceElements = document.querySelectorAll('.choice-item');
                choiceElements.forEach(element => {
                    const id = element.id.replace('choice-', '');
                    const editor = choiceEditors[id];
                    if (editor) {
                        const input = element.querySelector('input');
                        const isCorrect = input.checked;
                        const html = quillToHtml(editor);
                        if (html) {
                            choices.push({ html, isCorrect });
                        }
                    }
                });

                olx += `  <multiplechoiceresponse>\n`;
                olx += `    <label>${labelHtml}</label>\n`;
                olx += `    <choicegroup type="MultipleChoice" shuffle="true">\n`;

                choices.forEach(choice => {
                    const correct = choice.isCorrect ? 'true' : 'false';
                    olx += `      <choice correct="${correct}">${choice.html}</choice>\n`;
                });

                olx += `    </choicegroup>\n`;
                olx += `  </multiplechoiceresponse>\n`;

            } else {
                // choiceresponse (checkboxes)
                const choices = [];
                const choiceElements = document.querySelectorAll('.choice-item');
                choiceElements.forEach(element => {
                    const id = element.id.replace('choice-', '');
                    const editor = choiceEditors[id];
                    if (editor) {
                        const input = element.querySelector('input');
                        const isCorrect = input.checked;
                        const html = quillToHtml(editor);
                        if (html) {
                            choices.push({ html, isCorrect });
                        }
                    }
                });

                olx += `  <choiceresponse>\n`;
                olx += `    <label>${labelHtml}</label>\n`;
                olx += `    <checkboxgroup shuffle="true">\n`;

                choices.forEach(choice => {
                    const correct = choice.isCorrect ? 'true' : 'false';
                    olx += `      <choice correct="${correct}">${choice.html}</choice>\n`;
                });

                olx += `    </checkboxgroup>\n`;
                olx += `  </choiceresponse>\n`;
            }

            // Add solution/explanation
            if (explanationHtml) {
                olx += `  <solution>\n`;
                olx += `    <div class="detailed-solution">\n`;
                olx += `      <p>Explanation</p>\n`;
                olx += `      ${explanationHtml}\n`;
                olx += `    </div>\n`;
                olx += `  </solution>\n`;
            }

            // Add hints
            if (hints.length > 0) {
                olx += `  <demandhint>\n`;
                hints.forEach(hint => {
                    olx += `    <hint>${hint}</hint>\n`;
                });
                olx += `  </demandhint>\n`;
            }

            olx += `</problem>`;

            document.getElementById('olx-output').value = olx;
            isGenerating = false;
        }

        function copyOLX() {
            const output = document.getElementById('olx-output');
            if (!output.value) {
                generateOLX();
            }

            navigator.clipboard.writeText(output.value).then(() => {
                const feedback = document.getElementById('copyFeedback');
                feedback.classList.add('show');
                setTimeout(() => {
                    feedback.classList.remove('show');
                }, 2000);
            }).catch(err => {
                // Fallback for older browsers
                output.select();
                document.execCommand('copy');
                const feedback = document.getElementById('copyFeedback');
                feedback.classList.add('show');
                setTimeout(() => {
                    feedback.classList.remove('show');
                }, 2000);
            });
        }

        // Clear all editors
        function clearAllEditors() {
            // Clear main editors
            labelEditor.root.innerHTML = '';
            explanationEditor.root.innerHTML = '';

            // Clear choices
            document.getElementById('choices-container').innerHTML = '';
            choiceEditors = [];
            choiceCount = 0;

            // Clear hints
            document.getElementById('hints-container').innerHTML = '';
            hintEditors = [];
            hintCount = 0;

            // Clear answer fields
            document.getElementById('correct-answer').value = '';
            document.getElementById('answer-tolerance').value = '';
            document.getElementById('string-case-sensitive').checked = false;
        }

        // Add choice with content
        function addChoiceWithContent(html, isCorrect = false) {
            const container = document.getElementById('choices-container');
            const choiceId = choiceCount++;
            const problemType = document.getElementById('problemType').value;
            const inputType = problemType === 'choiceresponse' ? 'checkbox' : 'radio';

            const choiceDiv = document.createElement('div');
            choiceDiv.className = 'choice-item' + (isCorrect ? ' correct' : '');
            choiceDiv.id = `choice-${choiceId}`;
            choiceDiv.innerHTML = `
                <div class="choice-controls">
                    <label class="radio-label">
                        <input type="${inputType}" name="correct-choice" value="${choiceId}" ${isCorrect ? 'checked' : ''} onchange="updateCorrectChoice(${choiceId})">
                        Correct
                    </label>
                    <button class="btn btn-danger" onclick="removeChoice(${choiceId})">Remove</button>
                </div>
                <div class="choice-editor">
                    <div class="quill-wrapper small">
                        <div id="choice-editor-${choiceId}"></div>
                    </div>
                </div>
            `;
            container.appendChild(choiceDiv);

            const editor = new Quill(`#choice-editor-${choiceId}`, {
                theme: 'snow',
                modules: { toolbar: minimalToolbar },
                placeholder: 'Enter choice text...'
            });

            // Set content
            if (html) {
                editor.root.innerHTML = html;
            }

            choiceEditors[choiceId] = editor;
            return editor;
        }

        // Add hint with content
        function addHintWithContent(html) {
            const container = document.getElementById('hints-container');
            const hintId = hintCount++;

            const hintDiv = document.createElement('div');
            hintDiv.className = 'hint-item';
            hintDiv.id = `hint-${hintId}`;
            hintDiv.innerHTML = `
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <div style="flex: 1;">
                        <div class="quill-wrapper small">
                            <div id="hint-editor-${hintId}"></div>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="removeHint(${hintId})" style="margin-top: 8px;">Remove</button>
                </div>
            `;
            container.appendChild(hintDiv);

            const editor = new Quill(`#hint-editor-${hintId}`, {
                theme: 'snow',
                modules: { toolbar: minimalToolbar },
                placeholder: 'Enter hint text...'
            });

            if (html) {
                editor.root.innerHTML = html;
            }

            hintEditors[hintId] = editor;
            return editor;
        }

        // Import OLX into editor
        function importOLX(silent = false) {
            if (isGenerating) return; // Don't import while generating

            const olxText = document.getElementById('olx-output').value.trim();
            if (!olxText) {
                return;
            }

            // Quick check if it looks like OLX
            if (!olxText.includes('<problem')) {
                return;
            }

            isImporting = true;

            try {
                // Parse the XML
                const parser = new DOMParser();
                const doc = parser.parseFromString(olxText, 'text/xml');

                // Check for parse errors
                const parseError = doc.querySelector('parsererror');
                if (parseError) {
                    isImporting = false;
                    return; // Silently fail for invalid XML
                }

                // Clear existing content
                clearAllEditors();

                // Detect problem type
                const multipleChoice = doc.querySelector('multiplechoiceresponse');
                const checkboxChoice = doc.querySelector('choiceresponse');
                const numericalResponse = doc.querySelector('numericalresponse');
                const stringResponse = doc.querySelector('stringresponse');

                let problemType, responseElement;
                if (multipleChoice) {
                    problemType = 'multiplechoiceresponse';
                    responseElement = multipleChoice;
                } else if (checkboxChoice) {
                    problemType = 'choiceresponse';
                    responseElement = checkboxChoice;
                } else if (numericalResponse) {
                    problemType = 'numericalresponse';
                    responseElement = numericalResponse;
                } else if (stringResponse) {
                    problemType = 'stringresponse';
                    responseElement = stringResponse;
                } else {
                    isImporting = false;
                    return; // Unsupported problem type
                }

                // Set problem type dropdown and update UI
                document.getElementById('problemType').value = problemType;
                updateProblemType();

                // Extract label/question
                const labelEl = responseElement.querySelector('label');
                if (labelEl) {
                    labelEditor.root.innerHTML = labelEl.innerHTML;
                }

                // Handle different problem types
                if (problemType === 'numericalresponse') {
                    const answer = responseElement.getAttribute('answer') || '';
                    const tolerance = responseElement.getAttribute('tolerance') || '';
                    document.getElementById('correct-answer').value = answer;
                    document.getElementById('answer-tolerance').value = tolerance;

                } else if (problemType === 'stringresponse') {
                    const answer = responseElement.getAttribute('answer') || '';
                    const type = responseElement.getAttribute('type') || 'ci';
                    document.getElementById('correct-answer').value = answer;
                    document.getElementById('string-case-sensitive').checked = (type === 'cs');

                } else {
                    // Extract choices for multiple choice / checkbox
                    const choices = responseElement.querySelectorAll('choice');
                    choices.forEach(choice => {
                        const isCorrect = choice.getAttribute('correct') === 'true';
                        const html = choice.innerHTML;
                        addChoiceWithContent(html, isCorrect);
                    });
                }

                // Extract solution/explanation - get everything inside <solution>
                const solution = doc.querySelector('solution');
                if (solution) {
                    let content = solution.innerHTML;
                    // Remove <p>Explanation</p> header if present (case insensitive)
                    content = content.replace(/<p>\s*Explanation\s*<\/p>/gi, '');
                    explanationEditor.root.innerHTML = content.trim();
                }

                // Extract hints
                const demandHint = doc.querySelector('demandhint');
                if (demandHint) {
                    const hints = demandHint.querySelectorAll('hint');
                    hints.forEach(hint => {
                        addHintWithContent(hint.innerHTML);
                    });
                }

                // Show success feedback (unless silent)
                if (!silent) {
                    const feedback = document.getElementById('copyFeedback');
                    feedback.textContent = 'OLX imported!';
                    feedback.style.background = '#0075b4';
                    feedback.classList.add('show');
                    setTimeout(() => {
                        feedback.classList.remove('show');
                        feedback.textContent = 'Copied to clipboard!';
                        feedback.style.background = '#4caf50';
                    }, 1500);
                }

                // Delay resetting isImporting to prevent auto-generate from overwriting pasted OLX
                setTimeout(() => {
                    isImporting = false;
                }, 600);

            } catch (e) {
                console.error('Import error:', e);
                isImporting = false;
            }
        }

        // Auto-generate OLX on content change
        function setupAutoGenerate() {
            labelEditor.on('text-change', debounce(generateOLX, 500));
            explanationEditor.on('text-change', debounce(generateOLX, 500));
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize - start empty for import workflow
        setupAutoGenerate();

        // Auto-import when OLX is pasted
        const olxTextarea = document.getElementById('olx-output');
        olxTextarea.addEventListener('paste', (e) => {
            // Use setTimeout to let the paste complete first
            setTimeout(() => {
                importOLX(false);
            }, 50);
        });

        // Also try to import on input (for other paste methods)
        olxTextarea.addEventListener('input', debounce(() => {
            const text = olxTextarea.value.trim();
            if (text.includes('<problem') && !isGenerating) {
                importOLX(true); // Silent import on regular input
            }
        }, 300));
    </script>
</body>
</html>
