<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open edX Problem Editor</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }

        h1 {
            text-align: center;
            color: #0075b4;
            margin-bottom: 30px;
        }

        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .editor-container {
                grid-template-columns: 1fr;
            }
        }

        .editor-panel, .output-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .section {
            margin-bottom: 25px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .section-title {
            font-weight: 600;
            color: #444;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .editor-box {
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .toolbar {
            background: #fafafa;
            border-bottom: 1px solid #ddd;
            padding: 5px;
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
        }

        .toolbar button {
            background: white;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            min-width: 30px;
        }

        .toolbar button:hover {
            background: #e9e9e9;
        }

        .toolbar button:active {
            background: #d4d4d4;
        }

        .content-editable {
            min-height: 80px;
            padding: 10px;
            font-size: 14px;
            outline: none;
        }

        .content-editable:empty:before {
            content: attr(data-placeholder);
            color: #999;
        }

        .content-editable code {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 1px 5px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
            color: #c7254e;
        }

        .choice-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #eee;
        }

        .choice-item.correct {
            background: #e8f5e9;
            border-color: #a5d6a7;
        }

        .choice-controls {
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding-top: 5px;
        }

        .choice-editor {
            flex: 1;
        }

        .choice-editor .content-editable {
            min-height: 40px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #0075b4;
            color: white;
        }

        .btn-primary:hover {
            background: #005a8c;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-success:hover {
            background: #388e3c;
        }

        .btn-danger {
            background: #f44336;
            color: white;
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn-sm {
            padding: 4px 10px;
            font-size: 12px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
            white-space: nowrap;
        }

        .radio-label input {
            cursor: pointer;
        }

        #olx-output {
            width: 100%;
            height: 400px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #1e1e1e;
            color: #d4d4d4;
            resize: vertical;
        }

        .import-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .import-instructions {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .output-title {
            font-weight: 600;
            color: #444;
            font-size: 16px;
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        .copy-feedback {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .copy-feedback.show {
            opacity: 1;
        }

        .problem-type-selector {
            margin-bottom: 20px;
        }

        .problem-type-selector select {
            width: 100%;
            padding: 10px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }

        .hint-item {
            margin-bottom: 10px;
        }

        .hidden {
            display: none !important;
        }

        .validation-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 13px;
            display: none;
        }

        .validation-warning.show {
            display: block;
        }

        .answer-section {
            display: none;
        }

        .answer-section.visible {
            display: block;
        }

        .answer-input {
            width: 100%;
            padding: 12px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .answer-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .answer-options label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            color: #555;
        }

        .tolerance-input {
            width: 100px;
            padding: 8px;
            font-size: 13px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Open edX Problem Editor</h1>

    <div class="copy-feedback" id="copyFeedback">Copied to clipboard!</div>

    <div class="editor-container">
        <div class="output-panel">
            <div class="import-section">
                <div class="output-header">
                    <span class="output-title">OLX</span>
                </div>
                <p class="import-instructions">Paste OLX here to import and edit visually. Edits in the right panel auto-update this OLX.</p>
            </div>
            <textarea id="olx-output" placeholder="Paste OLX here..."></textarea>
            <div class="btn-group" style="margin-top: 15px; justify-content: flex-end;">
                <button class="btn btn-success" onclick="copyOLX()">Copy to Clipboard</button>
            </div>
        </div>

        <div class="editor-panel">
            <div class="problem-type-selector">
                <label class="section-title">Problem Type</label>
                <select id="problemType" onchange="updateProblemType()">
                    <option value="multiplechoiceresponse">Multiple Choice (Single Answer)</option>
                    <option value="choiceresponse">Checkboxes (Multiple Answers)</option>
                    <option value="numericalresponse">Numerical Response</option>
                    <option value="stringresponse">Text Response</option>
                </select>
            </div>

            <div class="section">
                <div class="section-header">
                    <span class="section-title">Problem Label / Question</span>
                </div>
                <div class="editor-box">
                    <div class="toolbar">
                        <button onclick="formatDoc('bold')" title="Bold"><b>B</b></button>
                        <button onclick="formatDoc('italic')" title="Italic"><i>I</i></button>
                        <button onclick="formatDoc('underline')" title="Underline"><u>U</u></button>
                        <button onclick="wrapWithTag('code')" title="Code">&lt;/&gt;</button>
                        <button onclick="insertLink()" title="Link">Link</button>
                    </div>
                    <div id="label-editor" class="content-editable" contenteditable="true" data-placeholder="Enter your question here..."></div>
                </div>
            </div>

            <div class="section" id="choices-section">
                <div class="section-header">
                    <span class="section-title">Answer Choices</span>
                    <button class="btn btn-primary btn-sm" onclick="addChoice()">+ Add Choice</button>
                </div>
                <div class="validation-warning" id="no-correct-warning">
                    No correct answer selected. Please mark at least one choice as correct.
                </div>
                <div id="choices-container"></div>
            </div>

            <div class="section answer-section" id="answer-section">
                <div class="section-header">
                    <span class="section-title">Correct Answer</span>
                </div>
                <input type="text" id="correct-answer" class="answer-input" placeholder="Enter the correct answer...">
                <div class="answer-options" id="numerical-options">
                    <label>
                        Tolerance: ±
                        <input type="text" id="answer-tolerance" class="tolerance-input" placeholder="e.g., 5%">
                    </label>
                </div>
                <div class="answer-options" id="string-options" style="display: none;">
                    <label>
                        <input type="checkbox" id="string-case-sensitive">
                        Case sensitive
                    </label>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <span class="section-title">Explanation / Solution</span>
                </div>
                <div class="editor-box">
                    <div class="toolbar">
                        <button onclick="formatDoc('bold')" title="Bold"><b>B</b></button>
                        <button onclick="formatDoc('italic')" title="Italic"><i>I</i></button>
                        <button onclick="formatDoc('underline')" title="Underline"><u>U</u></button>
                        <button onclick="wrapWithTag('code')" title="Code">&lt;/&gt;</button>
                        <button onclick="insertLink()" title="Link">Link</button>
                        <button onclick="formatDoc('insertUnorderedList')" title="Bullet List">• List</button>
                    </div>
                    <div id="explanation-editor" class="content-editable" contenteditable="true" data-placeholder="Enter the explanation/solution here..."></div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <span class="section-title">Hints (Optional)</span>
                    <button class="btn btn-primary btn-sm" onclick="addHint()">+ Add Hint</button>
                </div>
                <div id="hints-container"></div>
            </div>
        </div>
    </div>

    <script>
        // State
        let choiceCount = 0;
        let hintCount = 0;
        let isImporting = false;
        let isGenerating = false;

        // Format document using execCommand
        function formatDoc(command, value = null) {
            document.execCommand(command, false, value);
        }

        // Wrap selection with a tag
        function wrapWithTag(tag) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const selectedText = range.toString();
                if (selectedText) {
                    const element = document.createElement(tag);
                    element.textContent = selectedText;
                    range.deleteContents();
                    range.insertNode(element);
                    // Place cursor after the inserted element
                    range.setStartAfter(element);
                    range.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(range);
                    // Trigger OLX update since DOM manipulation doesn't fire input events
                    const editableEl = element.closest('.content-editable');
                    if (editableEl) {
                        editableEl.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
            }
        }

        // Insert a link
        function insertLink() {
            const url = prompt('Enter URL:');
            if (url) {
                formatDoc('createLink', url);
            }
        }

        // Get innerHTML from contenteditable, returns empty string if just whitespace
        function getEditorContent(id) {
            const el = document.getElementById(id);
            if (!el) return '';
            const html = el.innerHTML.trim();
            if (html === '' || html === '<br>') return '';
            return html;
        }

        // Choice management
        function addChoice(isCorrect = false, content = '') {
            const container = document.getElementById('choices-container');
            const choiceId = choiceCount++;
            const problemType = document.getElementById('problemType').value;
            const inputType = problemType === 'choiceresponse' ? 'checkbox' : 'radio';

            const choiceDiv = document.createElement('div');
            choiceDiv.className = 'choice-item' + (isCorrect ? ' correct' : '');
            choiceDiv.id = `choice-${choiceId}`;
            choiceDiv.innerHTML = `
                <div class="choice-controls">
                    <label class="radio-label">
                        <input type="${inputType}" name="correct-choice" value="${choiceId}" ${isCorrect ? 'checked' : ''} onchange="updateCorrectChoice(${choiceId})">
                        Correct
                    </label>
                    <button class="btn btn-danger" onclick="removeChoice(${choiceId})">Remove</button>
                </div>
                <div class="choice-editor">
                    <div class="editor-box">
                        <div class="toolbar">
                            <button onclick="formatDoc('bold')" title="Bold"><b>B</b></button>
                            <button onclick="formatDoc('italic')" title="Italic"><i>I</i></button>
                            <button onclick="wrapWithTag('code')" title="Code">&lt;/&gt;</button>
                        </div>
                        <div id="choice-editor-${choiceId}" class="content-editable" contenteditable="true" data-placeholder="Enter choice text..."></div>
                    </div>
                </div>
            `;
            container.appendChild(choiceDiv);

            if (content) {
                document.getElementById(`choice-editor-${choiceId}`).innerHTML = content;
            }

            return choiceId;
        }

        function removeChoice(id) {
            const element = document.getElementById(`choice-${id}`);
            if (element) {
                element.remove();
                generateOLX();
            }
        }

        function updateCorrectChoice(id) {
            const problemType = document.getElementById('problemType').value;

            if (problemType === 'choiceresponse') {
                const choiceDiv = document.getElementById(`choice-${id}`);
                const checkbox = choiceDiv.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    choiceDiv.classList.add('correct');
                } else {
                    choiceDiv.classList.remove('correct');
                }
            } else {
                document.querySelectorAll('.choice-item').forEach(item => {
                    item.classList.remove('correct');
                });
                const choiceDiv = document.getElementById(`choice-${id}`);
                if (choiceDiv) {
                    choiceDiv.classList.add('correct');
                }
            }
            generateOLX();
        }

        function validateChoices() {
            const problemType = document.getElementById('problemType').value;
            const warning = document.getElementById('no-correct-warning');

            if (problemType === 'numericalresponse' || problemType === 'stringresponse') {
                warning.classList.remove('show');
                return true;
            }

            const hasCorrect = document.querySelector('.choice-item input:checked') !== null;
            const hasChoices = document.querySelectorAll('.choice-item').length > 0;

            if (hasChoices && !hasCorrect) {
                warning.classList.add('show');
                return false;
            } else {
                warning.classList.remove('show');
                return true;
            }
        }

        function updateProblemType() {
            const problemType = document.getElementById('problemType').value;
            const choicesSection = document.getElementById('choices-section');
            const answerSection = document.getElementById('answer-section');
            const numericalOptions = document.getElementById('numerical-options');
            const stringOptions = document.getElementById('string-options');

            if (problemType === 'numericalresponse' || problemType === 'stringresponse') {
                choicesSection.classList.add('hidden');
                answerSection.classList.add('visible');

                if (problemType === 'numericalresponse') {
                    numericalOptions.style.display = 'flex';
                    stringOptions.style.display = 'none';
                    document.getElementById('correct-answer').placeholder = 'Enter the correct numerical answer...';
                } else {
                    numericalOptions.style.display = 'none';
                    stringOptions.style.display = 'flex';
                    document.getElementById('correct-answer').placeholder = 'Enter the correct text answer...';
                }
            } else {
                choicesSection.classList.remove('hidden');
                answerSection.classList.remove('visible');

                const inputType = problemType === 'choiceresponse' ? 'checkbox' : 'radio';
                document.querySelectorAll('.choice-item').forEach(item => {
                    const input = item.querySelector('input');
                    input.type = inputType;
                    if (inputType === 'radio') {
                        item.classList.remove('correct');
                        input.checked = false;
                    }
                });

                if (inputType === 'radio') {
                    const firstInput = document.querySelector('.choice-item input');
                    if (firstInput) {
                        firstInput.checked = true;
                        firstInput.closest('.choice-item').classList.add('correct');
                    }
                }
            }
            generateOLX();
        }

        // Hint management
        function addHint(content = '') {
            const container = document.getElementById('hints-container');
            const hintId = hintCount++;

            const hintDiv = document.createElement('div');
            hintDiv.className = 'hint-item';
            hintDiv.id = `hint-${hintId}`;
            hintDiv.innerHTML = `
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <div style="flex: 1;">
                        <div class="editor-box">
                            <div class="toolbar">
                                <button onclick="formatDoc('bold')" title="Bold"><b>B</b></button>
                                <button onclick="formatDoc('italic')" title="Italic"><i>I</i></button>
                                <button onclick="wrapWithTag('code')" title="Code">&lt;/&gt;</button>
                            </div>
                            <div id="hint-editor-${hintId}" class="content-editable" contenteditable="true" data-placeholder="Enter hint text..."></div>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="removeHint(${hintId})" style="margin-top: 8px;">Remove</button>
                </div>
            `;
            container.appendChild(hintDiv);

            if (content) {
                document.getElementById(`hint-editor-${hintId}`).innerHTML = content;
            }
        }

        function removeHint(id) {
            const element = document.getElementById(`hint-${id}`);
            if (element) {
                element.remove();
                generateOLX();
            }
        }

        // XML escaping
        function escapeXml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&apos;');
        }

        // Generate OLX
        function generateOLX() {
            if (isImporting) return;

            isGenerating = true;
            validateChoices();

            const problemType = document.getElementById('problemType').value;
            const labelHtml = getEditorContent('label-editor');
            const explanationHtml = getEditorContent('explanation-editor');

            // Gather hints
            const hints = [];
            document.querySelectorAll('.hint-item').forEach(element => {
                const id = element.id.replace('hint-', '');
                const html = getEditorContent(`hint-editor-${id}`);
                if (html) hints.push(html);
            });

            // Build OLX
            let olx = `<problem>\n`;

            if (problemType === 'numericalresponse') {
                const answer = escapeXml(document.getElementById('correct-answer').value || '');
                const tolerance = escapeXml(document.getElementById('answer-tolerance').value || '');

                olx += `  <numericalresponse answer="${answer}"`;
                if (tolerance) olx += ` tolerance="${tolerance}"`;
                olx += `>\n`;
                olx += `    <label>${labelHtml}</label>\n`;
                olx += `    <textline/>\n`;
                olx += `  </numericalresponse>\n`;

            } else if (problemType === 'stringresponse') {
                const answer = escapeXml(document.getElementById('correct-answer').value || '');
                const caseSensitive = document.getElementById('string-case-sensitive').checked;

                olx += `  <stringresponse answer="${answer}" type="${caseSensitive ? 'cs' : 'ci'}">\n`;
                olx += `    <label>${labelHtml}</label>\n`;
                olx += `    <textline size="20"/>\n`;
                olx += `  </stringresponse>\n`;

            } else if (problemType === 'multiplechoiceresponse') {
                const choices = [];
                document.querySelectorAll('.choice-item').forEach(element => {
                    const id = element.id.replace('choice-', '');
                    const input = element.querySelector('input');
                    const html = getEditorContent(`choice-editor-${id}`);
                    if (html) choices.push({ html, isCorrect: input.checked });
                });

                olx += `  <multiplechoiceresponse>\n`;
                olx += `    <label>${labelHtml}</label>\n`;
                olx += `    <choicegroup type="MultipleChoice" shuffle="true">\n`;
                choices.forEach(choice => {
                    olx += `      <choice correct="${choice.isCorrect}">${choice.html}</choice>\n`;
                });
                olx += `    </choicegroup>\n`;
                olx += `  </multiplechoiceresponse>\n`;

            } else {
                const choices = [];
                document.querySelectorAll('.choice-item').forEach(element => {
                    const id = element.id.replace('choice-', '');
                    const input = element.querySelector('input');
                    const html = getEditorContent(`choice-editor-${id}`);
                    if (html) choices.push({ html, isCorrect: input.checked });
                });

                olx += `  <choiceresponse>\n`;
                olx += `    <label>${labelHtml}</label>\n`;
                olx += `    <checkboxgroup shuffle="true">\n`;
                choices.forEach(choice => {
                    olx += `      <choice correct="${choice.isCorrect}">${choice.html}</choice>\n`;
                });
                olx += `    </checkboxgroup>\n`;
                olx += `  </choiceresponse>\n`;
            }

            // Add solution
            if (explanationHtml) {
                olx += `  <solution>\n`;
                olx += `    <div class="detailed-solution">\n`;
                olx += `      <p>Explanation</p>\n`;
                olx += `      ${explanationHtml}\n`;
                olx += `    </div>\n`;
                olx += `  </solution>\n`;
            }

            // Add hints
            if (hints.length > 0) {
                olx += `  <demandhint>\n`;
                hints.forEach(hint => {
                    olx += `    <hint>${hint}</hint>\n`;
                });
                olx += `  </demandhint>\n`;
            }

            olx += `</problem>`;

            document.getElementById('olx-output').value = olx;
            isGenerating = false;
        }

        // Copy OLX
        function copyOLX() {
            const output = document.getElementById('olx-output');
            if (!output.value) generateOLX();

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(output.value).then(() => {
                    showFeedback('Copied to clipboard!', '#4caf50');
                }).catch(() => {
                    output.select();
                    document.execCommand('copy');
                    showFeedback('Copied to clipboard!', '#4caf50');
                });
            } else {
                output.select();
                document.execCommand('copy');
                showFeedback('Copied to clipboard!', '#4caf50');
            }
        }

        let feedbackTimer = null;
        function showFeedback(text, color) {
            if (feedbackTimer) clearTimeout(feedbackTimer);
            const feedback = document.getElementById('copyFeedback');
            feedback.textContent = text;
            feedback.style.background = color;
            feedback.classList.add('show');
            feedbackTimer = setTimeout(() => {
                feedback.classList.remove('show');
                feedbackTimer = null;
            }, 2000);
        }

        // Clear all editors
        function clearAllEditors() {
            document.getElementById('label-editor').innerHTML = '';
            document.getElementById('explanation-editor').innerHTML = '';
            document.getElementById('choices-container').innerHTML = '';
            document.getElementById('hints-container').innerHTML = '';
            document.getElementById('correct-answer').value = '';
            document.getElementById('answer-tolerance').value = '';
            document.getElementById('string-case-sensitive').checked = false;
            choiceCount = 0;
            hintCount = 0;
        }

        // Import OLX
        function importOLX(silent = false) {
            if (isGenerating) return;

            const olxText = document.getElementById('olx-output').value.trim();
            if (!olxText || !olxText.includes('<problem')) return;

            isImporting = true;

            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(olxText, 'text/xml');

                if (doc.querySelector('parsererror')) {
                    isImporting = false;
                    return;
                }

                clearAllEditors();

                // Detect problem type
                const multipleChoice = doc.querySelector('multiplechoiceresponse');
                const checkboxChoice = doc.querySelector('choiceresponse');
                const numericalResponse = doc.querySelector('numericalresponse');
                const stringResponse = doc.querySelector('stringresponse');

                let problemType, responseElement;
                if (multipleChoice) {
                    problemType = 'multiplechoiceresponse';
                    responseElement = multipleChoice;
                } else if (checkboxChoice) {
                    problemType = 'choiceresponse';
                    responseElement = checkboxChoice;
                } else if (numericalResponse) {
                    problemType = 'numericalresponse';
                    responseElement = numericalResponse;
                } else if (stringResponse) {
                    problemType = 'stringresponse';
                    responseElement = stringResponse;
                } else {
                    isImporting = false;
                    return;
                }

                document.getElementById('problemType').value = problemType;
                updateProblemType();

                // Helper to get inner content
                const getInnerContent = (el) => {
                    if (!el) return '';
                    const serializer = new XMLSerializer();
                    let content = '';
                    for (const child of el.childNodes) {
                        content += serializer.serializeToString(child);
                    }
                    return content.replace(/\s*xmlns="[^"]*"/g, '');
                };

                // Extract label
                const labelEl = responseElement.querySelector('label');
                if (labelEl) {
                    document.getElementById('label-editor').innerHTML = getInnerContent(labelEl);
                }

                // Handle different problem types
                if (problemType === 'numericalresponse') {
                    document.getElementById('correct-answer').value = responseElement.getAttribute('answer') || '';
                    document.getElementById('answer-tolerance').value = responseElement.getAttribute('tolerance') || '';
                } else if (problemType === 'stringresponse') {
                    document.getElementById('correct-answer').value = responseElement.getAttribute('answer') || '';
                    document.getElementById('string-case-sensitive').checked = responseElement.getAttribute('type') === 'cs';
                } else {
                    const choices = responseElement.querySelectorAll('choice');
                    choices.forEach(choice => {
                        const isCorrect = choice.getAttribute('correct') === 'true';
                        addChoice(isCorrect, getInnerContent(choice));
                    });
                }

                // Extract solution
                const solution = doc.querySelector('solution');
                if (solution) {
                    // Try to get content from inside detailed-solution div to avoid nesting on round-trip
                    const detailedDiv = solution.querySelector('[class="detailed-solution"]');
                    const sourceEl = detailedDiv || solution;
                    let content = getInnerContent(sourceEl);
                    // Strip "Explanation" header paragraph
                    content = content.replace(/<p>\s*Explanation\s*<\/p>/gi, '');
                    document.getElementById('explanation-editor').innerHTML = content.trim();
                }

                // Extract hints
                const demandHint = doc.querySelector('demandhint');
                if (demandHint) {
                    const hints = demandHint.querySelectorAll('hint');
                    hints.forEach(hint => addHint(getInnerContent(hint)));
                }

                if (!silent) {
                    showFeedback('OLX imported!', '#0075b4');
                }

                setTimeout(() => { isImporting = false; }, 600);

            } catch (e) {
                console.error('Import error:', e);
                isImporting = false;
            }
        }

        // Prevent toolbar buttons from stealing focus from contenteditable
        document.querySelector('.editor-panel').addEventListener('mousedown', (e) => {
            if (e.target.closest('.toolbar')) {
                e.preventDefault();
            }
        });

        // Auto-import on paste
        const olxTextarea = document.getElementById('olx-output');
        olxTextarea.addEventListener('paste', () => {
            setTimeout(() => importOLX(false), 50);
        });

        // Auto-generate OLX when editing preview boxes
        function debounce(func, wait) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }

        const debouncedGenerate = debounce(generateOLX, 400);

        // Listen on the editor panel for any input in contenteditable areas
        document.querySelector('.editor-panel').addEventListener('input', (e) => {
            if (e.target.classList.contains('content-editable')) {
                debouncedGenerate();
            }
        });

        // Also regenerate when correct answer, tolerance, or case-sensitivity changes
        document.getElementById('correct-answer').addEventListener('input', debouncedGenerate);
        document.getElementById('answer-tolerance').addEventListener('input', debouncedGenerate);
        document.getElementById('string-case-sensitive').addEventListener('change', debouncedGenerate);
    </script>
</body>
</html>
